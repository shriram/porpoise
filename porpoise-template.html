<!DOCTYPE html>
<html>

@|warning-comment|

<head>
  <title>Purpose Statement Evaluator</title>

  <style>
    #outcomes td {
      text-align: right
    }

    /* Colors were generated by gpt-3.5-turbo in response to a request for
   a green-ish, red-ish, and deeper red-ish color that are not problematic
   for color-blind people. */
    #outcomes td.success {
      text-align: center;
      background-color: #00CC66
    }

    #outcomes td.failure {
      text-align: left;
      background-color: #FF6666
    }

    #outcomes td.error {
      text-align: center;
      background-color: #CC0033
    }

    #examples td {
      font-family: monospace
    }

    .vertical-space {
      padding-bottom: 20px;
    }
  </style>

</head>

<body>

  <script type="text/javascript">

    const OpenAI = "OpenAI"; // name of organization whose tool we are using

    function disableElt(eId) {
      e = document.getElementById(eId);
      e.disabled = true
    }
    function enableElt(eId) {
      e = document.getElementById(eId);
      e.disabled = false
    }

    function rkt(e) {
      switch (typeof e) {
	case 'object':
          // assuming the only kind of object is an array (for now)
          if (e.length == 0) {
            return "empty";
          } else {
            return "[list: " + e.map(i => rkt(i)).join(", ") + "]";
          }
        default:
          return e;
      }
    }

    var currentExamples;

    function fetchCheckTimeoutAndPresent(endpoint, focalElement, onJSONResponse) {
      fetch(endpoint)
        .then(response => {//document.getElementById(focalElement).innerText = '';
                           // remove the above because it causes the element to blank out a bit too soon; move into continuations
                           return response.text()})
        .then(responseText => {
          const expiredString = 'this page has expired';
          if (responseText.includes(expiredString)) {
            document.getElementById(focalElement).innerText = '';
            document.getElementById(focalElement).innerHTML = "Session expired.<br/>Please restart to resume.<br/>(Remember to copy your prompt!)</p>";
            return;
          }
          let rJson;
          try {
            rJson = JSON.parse(responseText);
            document.getElementById(focalElement).innerText = '';
            onJSONResponse(rJson);
          } catch (jsonError) {
            console.log("JSON error: " + jsonError);
            document.getElementById(focalElement).innerText = '';
            document.getElementById(focalElement).innerHTML = "<p>Internal error: JSON error.<br/>Please reload and try again, and report if it persists.</p>";
          }
        })
    }

    function getProblemExamples() {
      enableElt("reset-problem");
      disableElt("problem-chosen");

      let problemName = document.getElementById('problem-selector').value;
      let pN = encodeURIComponent(problemName);
      fetchCheckTimeoutAndPresent("@|examples-response-point|" + "?problem=" + pN, "examples", showExamplesAndMaybeBadImpl);

      enableElt("prompt");
    }

    function evaluatePrompt() {
      disableElt("prompt-ready");
      document.getElementById("outcomes").innerHTML = "Communicating with servers. Please wait up to 30 seconds. <progress></progress>";

      var rslt = "";
      var problemName = document.getElementById('problem-selector').value;
      var promptText = document.getElementById('prompt').value;
      var pN = encodeURIComponent(problemName);
      var pT = encodeURIComponent(promptText);
      fetchCheckTimeoutAndPresent("@|evaluation-response-point|" + "?problem=" + pN + "&prompt=" + pT, "outcomes", showOutcomes);

      enableElt("reset-problem");
    }

    function showExamplesAndMaybeBadImpl(resp) {
      var badImpl = null;
      var egs = null;
      switch (resp["type"]) {
        case 'bad-impl-and-egs':
          badImpl = resp["bad-impl"];
	  egs = resp["examples"];
	case 'egs-only':
	  egs = resp["examples"];
      }
      currentExamples = egs; // global var, don't put `var` in front!
      const examplesTable = document.getElementById("examples");
      const arityInEgs = egs[0]["inputs"].length;
      let tableInProg = `<table border="1" cellspacing="0" cellpadding="5">
		     <tr><th colspan="${arityInEgs}">Input${((arityInEgs == 1) ? "" : "s")}</th><th>Output</th></tr>`;
      // need the join else you get commas: https://stackoverflow.com/questions/45812160/unexpected-comma-using-map
      egs.forEach(eg => tableInProg += ' ' + "<tr>" + eg["inputs"].map(i => `<td>${rkt(i)}</td>`).join('') + `<td>${rkt(eg["output"])}</td></tr>`);
      tableInProg += '</table>';
      examplesTable.innerHTML = tableInProg;
      const badImplArea = document.getElementById("bad-impl");
      if (badImpl) {
        badImplArea.innerHTML = '<h3>Buggy Implementation</h3>' + '<pre>' + badImpl + '</pre>';
      } else {
        badImplArea.innerHTML = '';
      }
    }

  function showOutcomes(rsltContainer) {
      const outcomesTable = document.getElementById("outcomes");

      if (rsltContainer["type"] == "no-runs") {
        outcomesTable.insertAdjacentHTML("beforeend", `<p>Unfortunately, there were no valid runs.<br/>Most probably this is because the ${OpenAI} servers are down.<br/>Please try again.</p>`);
        enableElt("prompt-ready");
        return;
      }
      if (rsltContainer["type"] != "runs") {
        outcomesTable.insertAdjacentHTML("beforeend", `<p>Internal error: got result container ${rsltContainer["type"]} in <tt>showOutcomes</tt>.</p>`);
        enableElt("prompt-ready");
        return;
      }
      // so the result is indeed "runs"
      privCount = rsltContainer["priv-count"];
      pubCount = rsltContainer["pub-count"];
      rsltMatrix = rsltContainer["info"];

      let outcomesHTML = `<table border="1" cellspacing="0" cellpadding="5">`; // </table> needs to go after the loop
      outcomesHTML += `<tr><th>Implementation</th><th colspan="${privCount}">Private</th><th colspan="${pubCount}">Public</th></tr>`;

      outcomesHTML += `<tr><td>              </td><td colspan="${privCount}">       </td>${currentExamples.map(eg => `<td style="text-align:left; font-family: monospace;">${eg["output"]}</td>`).join('')}</tr>`;

      for (let idx in rsltMatrix) {
        outcomesHTML += `<tr><th>${Number(idx) + 1}</th>`; // </tr> needs to be the last thing in the loop
        let rslt = rsltMatrix[idx];
        switch (rslt["type"]) {
          case "non-code":
            outcomesHTML += `<td colspan="1000" style="text-align:center;">Generated code was not valid, please re-check your prompt</td>`;
            break;
          case "eval-error":
            outcomesHTML += `<td colspan="1000" style="text-align:center;">Error running generated code, please re-check your prompt</td>`;
            break;
          case "server-timeout":
            outcomesHTML += `<td colspan="1000" style="text-align:center;">Timeout generating code (most probably a load issue)</td>`;
            break;
          case "server-error":
            outcomesHTML += `<td colspan="1000" style="text-align:center;">${OpenAI} server error (most probably a load issue)</td>`;
            enableElt("prompt-ready");
            break;
          case "code":
            let info = rslt["info"];
            let privOuts = info["private"]["outcomes"];
            let pubOuts = info["public"]["outcomes"];
            for (let pvOidx in privOuts) {
              let pvOut = privOuts[pvOidx]["outcome"];
              outcomesHTML += `<td class="${pvOut}">${pvOut}</td>`;
            }
            for (let pbOidx in pubOuts) {
              let pbOut = pubOuts[pbOidx]["outcome"];
              outcomesHTML += `<td class="${pbOut}">${((pbOut == "failure") ? `<pre>${rkt(pubOuts[pbOidx]["details"])}</pre>` : pbOut)}</td>`;
            }
            break;
          default:
            outcomesHTML += `<td colspan="1000" style="text-align:center;">Unknown outcome: ${rslt["type"]}</td>`;
        }
        outcomesHTML += `</tr>`;
      }

      outcomesHTML += `</table>`;
      outcomesTable.insertAdjacentHTML("beforeend", outcomesHTML);
    }

    function handlePromptKeys(e) {
      if (e.target.value.length >= 5) {
        enableElt("prompt-ready");
      } else {
        disableElt("prompt-ready");
      }
    }

    function handleResetProblem() {
      enableElt("problem-selector");
      document.getElementById("bad-impl").innerHTML = "";
      document.getElementById("examples").innerHTML = "";
      document.getElementById("prompt").value = "";
      document.getElementById("outcomes").innerHTML = "";
      disableElt("prompt");
      disableElt("prompt-ready");
    }

    function handleProblemSelected() {
      enableElt("problem-chosen");
    }

  </script>

  <p align="center">
      Porpoise
      <a
      href="https://docs.google.com/document/d/1zV5BoJjbeBfNcM6dnyypgpvekw6rcMz_s6ZsK1W-Ozk/edit" target="_blank">Dokumentation auf Deutsch</a>
      &
      <a href="https://docs.google.com/document/d/1dHCev4LBFOQWKYQ1xA6i11uU7GCRHhAoMrVT2Ev_6wQ/edit?usp=sharing" target="_blank">documentation in English</a>.
  </p>

  <div class="vertical-space"></div>

  <div>
    Choose problem:&nbsp;<select id="problem-selector">
      @in[p problem-names]{
      <option value="@|p|">@|p|</option>
      }
    </select>&nbsp;&nbsp;&nbsp;<button id="problem-chosen">Go!</button>
  </div>

  <div class="vertical-space"></div>

  <script type="text/javascript">
    document.getElementById("problem-selector").addEventListener("change", handleProblemSelected);
    document.getElementById("problem-chosen").addEventListener("click", getProblemExamples);
  </script>

  <div class="vertical-space"></div>

  <div id="bad-impl">
  </div>

  <div class="vertical-space"></div>

  <div id="examples">
  </div>

  <div class="vertical-space"></div>

  <div>
    <textarea id="prompt" rows="5" cols="50" disabled></textarea>&nbsp;&nbsp;&nbsp;<button id="prompt-ready"
      disabled>Evaluate purpose statement</button>
  </div>

  <script type="text/javascript">
    document.getElementById("prompt").addEventListener("beforeinput", handlePromptKeys);
    document.getElementById("prompt-ready").addEventListener("click", evaluatePrompt);
  </script>

  <div class="vertical-space"></div>

  <div id="outcomes">
  </div>

  <div class="vertical-space"></div>

  <div>
    <button id="reset-problem" disabled>Work on new problem</button>
  </div>

  <script type="text/javascript">
    document.getElementById("reset-problem").addEventListener("click", handleResetProblem);
  </script>

  <div class="vertical-space"></div>

</body>

</html>